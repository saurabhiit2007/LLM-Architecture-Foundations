
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="The theoretical building blocks. "How is the model built?"">
      
      
        <meta name="author" content="Saurabh Goyal">
      
      
      
        <link rel="prev" href="../mha/">
      
      
        <link rel="next" href="../gqa/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.23">
    
    
      
        <title>Multi Query Attention (MQA) - LLM-Architecture_Foundations</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#1-overview" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LLM-Architecture_Foundations" class="md-header__button md-logo" aria-label="LLM-Architecture_Foundations" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LLM-Architecture_Foundations
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Multi Query Attention (MQA)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="deep-purple"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="lime"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/saurabhiit2007/LLM-Architecture-Foundations" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LLM-Architecture_Foundations" class="md-nav__button md-logo" aria-label="LLM-Architecture_Foundations" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    LLM-Architecture_Foundations
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/saurabhiit2007/LLM-Architecture-Foundations" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Model Architecture Families
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Model Architecture Families
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model_architecture_families/encoder_decoder_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Encoder Decoder Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model_architecture_families/dense_vs_sparse_models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dense vs Sparse Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../model_architecture_families/mixture_of_experts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mixture of Models (MoE)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Attention Mechanisms
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Attention Mechanisms
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mha/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-Head Attention
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Multi Query Attention (MQA)
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Multi Query Attention (MQA)
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-overview" class="md-nav__link">
    <span class="md-ellipsis">
      1. Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-problem-the-kv-cache-bottleneck" class="md-nav__link">
    <span class="md-ellipsis">
      The Problem: The KV Cache Bottleneck
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-architecture-comparison" class="md-nav__link">
    <span class="md-ellipsis">
      2. Architecture Comparison
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Architecture Comparison">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-head-attention-mha" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Head Attention (MHA)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-query-attention-mqa" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Query Attention (MQA)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-why-it-matters" class="md-nav__link">
    <span class="md-ellipsis">
      3. Why it Matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-training-vs-inference-the-impact-of-mqa" class="md-nav__link">
    <span class="md-ellipsis">
      4. Training vs. Inference: The Impact of MQA
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Training vs. Inference: The Impact of MQA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-during-training-parallel-processing" class="md-nav__link">
    <span class="md-ellipsis">
      A. During Training (Parallel Processing)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-during-inference-autoregressive-decoding" class="md-nav__link">
    <span class="md-ellipsis">
      B. During Inference (Autoregressive Decoding)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-the-recent-evolution-grouped-query-attention-gqa" class="md-nav__link">
    <span class="md-ellipsis">
      5. The Recent Evolution: Grouped-Query Attention (GQA)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-comparison-summary" class="md-nav__link">
    <span class="md-ellipsis">
      6. Comparison Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-potential-interview-questions" class="md-nav__link">
    <span class="md-ellipsis">
      7. Potential Interview Questions
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gqa/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Grouped Query Attention (GQA)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sliding_window/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sliding Window
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Real World Model Families
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Real World Model Families
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../real_world_model_families/claude/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Claude
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../real_world_model_families/llama/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Llama
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../real_world_model_families/gemini/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Gemini
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../real_world_model_families/openai/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenAI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../real_world_model_families/mistral/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Mistral
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../real_world_model_families/dense_vs_MoE_comparison/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dense vs MoE Comparison
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../real_world_model_families/general_comparison/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    General Comparison
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Transformer Components
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Transformer Components
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Tokenization
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Tokenization
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tokenization/unigram/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unigram
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tokenization/sentence_piece_unigram/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sentence Piece Unigram
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tokenization/byte_pair_encoding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Byte Pair Encoding
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tokenization/tiktoken/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TikToken
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tokenization/vocabulary_size_tradeoffs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Vocabulary Size Tradeoffs
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Positional Encodings
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Positional Encodings
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../positional_encodings/RoPE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RoPE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../positional_encodings/ALiBi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ALiBi
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pretraining objective
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Pretraining objective
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Scaling laws
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            Scaling laws
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../references.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    References
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-overview" class="md-nav__link">
    <span class="md-ellipsis">
      1. Overview
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Overview">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-problem-the-kv-cache-bottleneck" class="md-nav__link">
    <span class="md-ellipsis">
      The Problem: The KV Cache Bottleneck
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-architecture-comparison" class="md-nav__link">
    <span class="md-ellipsis">
      2. Architecture Comparison
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Architecture Comparison">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#multi-head-attention-mha" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Head Attention (MHA)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-query-attention-mqa" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Query Attention (MQA)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-why-it-matters" class="md-nav__link">
    <span class="md-ellipsis">
      3. Why it Matters
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-training-vs-inference-the-impact-of-mqa" class="md-nav__link">
    <span class="md-ellipsis">
      4. Training vs. Inference: The Impact of MQA
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Training vs. Inference: The Impact of MQA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#a-during-training-parallel-processing" class="md-nav__link">
    <span class="md-ellipsis">
      A. During Training (Parallel Processing)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#b-during-inference-autoregressive-decoding" class="md-nav__link">
    <span class="md-ellipsis">
      B. During Inference (Autoregressive Decoding)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-the-recent-evolution-grouped-query-attention-gqa" class="md-nav__link">
    <span class="md-ellipsis">
      5. The Recent Evolution: Grouped-Query Attention (GQA)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-comparison-summary" class="md-nav__link">
    <span class="md-ellipsis">
      6. Comparison Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-potential-interview-questions" class="md-nav__link">
    <span class="md-ellipsis">
      7. Potential Interview Questions
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Multi Query Attention (MQA)</h1>

<h2 id="1-overview">1. Overview<a class="headerlink" href="#1-overview" title="Permanent link">&para;</a></h2>
<p><strong>Multi-Query Attention (MQA)</strong> is a variation of the standard Multi-Head Attention (MHA) designed to significantly reduce the memory and computational overhead during inference, specifically by optimizing the <strong>KV (Key-Value) Cache</strong>.</p>
<h3 id="the-problem-the-kv-cache-bottleneck">The Problem: The KV Cache Bottleneck<a class="headerlink" href="#the-problem-the-kv-cache-bottleneck" title="Permanent link">&para;</a></h3>
<p>In standard Transformers, as the sequence length and batch size grow, the memory required to store Keys and Values for every head becomes the primary bottleneck. This limits throughput and maximum context window sizes.</p>
<hr />
<hr />
<h2 id="2-architecture-comparison">2. Architecture Comparison<a class="headerlink" href="#2-architecture-comparison" title="Permanent link">&para;</a></h2>
<h3 id="multi-head-attention-mha">Multi-Head Attention (MHA)<a class="headerlink" href="#multi-head-attention-mha" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Structure:</strong> Each head has its own <span class="arithmatex">\(Q\)</span>, <span class="arithmatex">\(K\)</span>, and <span class="arithmatex">\(V\)</span> linear projections.</li>
<li><strong>Memory:</strong> If there are <span class="arithmatex">\(h\)</span> heads, we store <span class="arithmatex">\(h\)</span> sets of Keys and Values.</li>
<li><strong>Math:</strong> <span class="arithmatex">\(Q_i = XW^Q_i, K_i = XW^K_i, V_i = XW^V_i\)</span> for <span class="arithmatex">\(i \in \{1, \dots, h\}\)</span>.</li>
</ul>
<h3 id="multi-query-attention-mqa">Multi-Query Attention (MQA)<a class="headerlink" href="#multi-query-attention-mqa" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Structure:</strong> Multiple <strong>Query</strong> heads remain, but they all share a <strong>single Key head</strong> and a <strong>single Value head</strong>.</li>
<li><strong>Memory:</strong> Reduces the KV cache size by a factor of <span class="arithmatex">\(h\)</span>.</li>
<li><strong>Math:</strong> <span class="arithmatex">\(Q_i = XW^Q_i\)</span>, but <span class="arithmatex">\(K = XW^K\)</span> and <span class="arithmatex">\(V = XW^V\)</span> (no index <span class="arithmatex">\(i\)</span> for K and V).</li>
</ul>
<hr />
<hr />
<h2 id="3-why-it-matters">3. Why it Matters<a class="headerlink" href="#3-why-it-matters" title="Permanent link">&para;</a></h2>
<p>We use MQA to imporve <strong>Inference Efficiency</strong>:</p>
<ol>
<li>
<p><strong>Reduced VRAM Footprint:</strong> You can fit much larger batches or longer sequences into the same GPU memory.</p>
</li>
<li>
<p><strong>Increased Memory Bandwidth:</strong> In MHA, the GPU often spends more time moving data (KV caches) than actually performing math. MQA reduces data movement, leading to massive speedups in token generation.</p>
</li>
</ol>
<hr />
<hr />
<h2 id="4-training-vs-inference-the-impact-of-mqa">4. Training vs. Inference: The Impact of MQA<a class="headerlink" href="#4-training-vs-inference-the-impact-of-mqa" title="Permanent link">&para;</a></h2>
<p><strong>MQA is primarily an inference-time optimization.</strong> While it changes the architecture, its benefits are not felt equally across the model's lifecycle.</p>
<h3 id="a-during-training-parallel-processing">A. During Training (Parallel Processing)<a class="headerlink" href="#a-during-training-parallel-processing" title="Permanent link">&para;</a></h3>
<p>During training, we use <strong>Teacher Forcing</strong>, meaning the entire sequence is processed at once.</p>
<ul>
<li><strong>Memory Efficiency:</strong> The savings are <strong>negligible</strong>. In training, the activation memory (storing gradients and intermediate states for backprop) far outweighs the memory used by Keys and Values.</li>
<li><strong>Speed:</strong> Training speed remains roughly the same because the GPU is already "compute-bound." The overhead of multiple KV heads is small compared to the massive matrix multiplications (<span class="arithmatex">\(MatMul\)</span>) happening in parallel.</li>
<li><strong>The "Cost":</strong> Training with MQA is actually <strong>harder</strong>. Because all query heads share one KV head, the model has fewer parameters to learn distinct relationships, which can lead to training instability or slightly higher perplexity (lower accuracy).</li>
</ul>
<h3 id="b-during-inference-autoregressive-decoding">B. During Inference (Autoregressive Decoding)<a class="headerlink" href="#b-during-inference-autoregressive-decoding" title="Permanent link">&para;</a></h3>
<p>During inference, we generate one token at a time. This is where MQA shines.
* <strong>The KV Cache Bottleneck:</strong> In autoregressive generation, we store every previous token's Key and Value so we don't recompute them. In MHA, this "KV Cache" grows so large it can't fit in the fast on-chip memory (SRAM) and spills into slower VRAM (HBM).
* <strong>Memory Bandwidth:</strong> Inference is <strong>memory-bound</strong>, not compute-bound. The GPU spends most of its time "waiting" for the KV Cache to load from memory.
* <strong>The MQA Advantage:</strong> By reducing KV heads to 1, we reduce the data movement by <span class="arithmatex">\(h\)</span> times (where <span class="arithmatex">\(h\)</span> is the number of heads). This allows for:
    * <strong>Larger Batch Sizes:</strong> Fit more users/requests on one GPU.
    * <strong>Lower Latency:</strong> Tokens are generated much faster because the "memory bottleneck" is cleared.</p>
<hr />
<hr />
<h2 id="5-the-recent-evolution-grouped-query-attention-gqa">5. The Recent Evolution: Grouped-Query Attention (GQA)<a class="headerlink" href="#5-the-recent-evolution-grouped-query-attention-gqa" title="Permanent link">&para;</a></h2>
<p>MQA is often seen as the "extreme" version. Most modern models (like <strong>Llama 3</strong> and <strong>Mistral</strong>) use <strong>Grouped-Query Attention (GQA)</strong>.</p>
<ul>
<li><strong>Mechanism:</strong> Instead of 1 KV head for <em>all</em> query heads, GQA creates groups. For example, if you have 32 Query heads, you might have 8 KV heads (one for every 4 queries).</li>
<li><strong>The "Goldilocks" Solution:</strong> It provides a middle groundâ€”retaining the speed of MQA while keeping the representational power (accuracy) of MHA.</li>
</ul>
<hr />
<hr />
<h2 id="6-comparison-summary">6. Comparison Summary<a class="headerlink" href="#6-comparison-summary" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Feature</th>
<th style="text-align: left;">Multi-Head (MHA)</th>
<th style="text-align: left;">Multi-Query (MQA)</th>
<th style="text-align: left;">Grouped-Query (GQA)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>KV Heads</strong></td>
<td style="text-align: left;"><span class="arithmatex">\(h\)</span> (Same as Query)</td>
<td style="text-align: left;">1</td>
<td style="text-align: left;"><span class="arithmatex">\(1 &lt; g &lt; h\)</span></td>
</tr>
<tr>
<td style="text-align: left;"><strong>Memory Efficiency</strong></td>
<td style="text-align: left;">Low (Bottleneck)</td>
<td style="text-align: left;">Highest</td>
<td style="text-align: left;">High</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Inference Speed</strong></td>
<td style="text-align: left;">Base</td>
<td style="text-align: left;">~10x Faster</td>
<td style="text-align: left;">~8-9x Faster</td>
</tr>
<tr>
<td style="text-align: left;"><strong>Model Quality</strong></td>
<td style="text-align: left;">Highest</td>
<td style="text-align: left;">Significant Drop</td>
<td style="text-align: left;">Near-MHA Quality</td>
</tr>
</tbody>
</table>
<hr />
<hr />
<h2 id="7-potential-interview-questions">7. Potential Interview Questions<a class="headerlink" href="#7-potential-interview-questions" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>"Does MQA affect training speed?"</strong> * </li>
<li>
<p><em>Answer:</em> Primarily no. The benefit is most realized during <em>incremental decoding</em> (inference). During training, the overhead of KV heads is negligible compared to the full backprop.</p>
</li>
<li>
<p><strong>"Why would we ever use MHA if MQA is faster?"</strong> </p>
</li>
<li>
<p><em>Answer:</em> Performance. For tasks requiring very fine-grained attention to different parts of a sequence simultaneously, MHA is more expressive.</p>
</li>
<li>
<p><strong>"Can I use MQA on a model already trained with MHA?"</strong></p>
</li>
<li><em>Answer:</em> Yes, via "Uptraining." You can convert an MHA checkpoint to MQA by mean-pooling the <span class="arithmatex">\(K\)</span> and <span class="arithmatex">\(V\)</span> heads into a single head and then performing a small amount of additional training (usually ~5% of the original compute) to help the model adapt.</li>
</ul>
<hr />












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.expand", "navigation.top", "search.highlight", "search.share", "content.code.copy", "mathjax"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>